<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbital Energy Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.27.1/plotly.min.js"></script>
    <!-- 前面的样式保持不变 -->
    <style>
        /* 之前的所有CSS保持不变 */
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* ... 其他CSS样式保持不变 ... */
    </style>
</head>
<body>
    <!-- HTML结构保持不变 -->
    <div class="container">
        <h1>Orbital Energy Calculator</h1>
        
        <div class="input-section">
            <!-- 输入部分的HTML保持不变 -->
            <!-- ... -->
        </div>
        
        <div class="energy-gap">
            <h3>Energy Gap:</h3>
            <div id="gap-value">Calculating...</div>
        </div>
        
        <div id="plot" class="chart-container"></div>
        
        <div class="error" id="error-message"></div>
    </div>

    <script>
        let orbitalData = {
            energies: [],
            homoIndex: null,
            lumoIndex: null
        };
        
        // 更新绘图函数，完全重绘而不是更新
        function updatePlot(index1, index2) {
            // 基础轨道能量曲线
            const allOrbitalTrace = {
                x: Array.from({length: orbitalData.energies.length}, (_, i) => i),
                y: orbitalData.energies,
                mode: 'lines',
                name: 'All Orbitals',
                line: {
                    color: '#2196f3',
                    width: 2
                },
                hovertemplate: 'Orbital: %{x}<br>Energy: %{y:.4f} eV<extra></extra>'
            };

            // 特殊轨道标记（HOMO, LUMO等）
            const specialOrbitalTrace = {
                x: [orbitalData.homoIndex-1, orbitalData.homoIndex, orbitalData.lumoIndex, orbitalData.lumoIndex+1],
                y: [
                    orbitalData.energies[orbitalData.homoIndex-1],
                    orbitalData.energies[orbitalData.homoIndex],
                    orbitalData.energies[orbitalData.lumoIndex],
                    orbitalData.energies[orbitalData.lumoIndex+1]
                ],
                mode: 'markers+text',
                name: 'Reference Orbitals',
                marker: {
                    size: 8,
                    color: ['#9c27b0', '#2196f3', '#ff9800', '#9c27b0'],
                },
                text: ['HOMO-1', 'HOMO', 'LUMO', 'LUMO+1'],
                textposition: 'top',
                hovertemplate: '%{text}<br>Energy: %{y:.4f} eV<extra></extra>'
            };

            // 选中的轨道
            const selectedPoints = {
                x: [],
                y: [],
                text: [],
                mode: 'markers+text',
                name: 'Selected Orbitals',
                marker: {
                    size: 10,
                    color: '#f44336'
                },
                textposition: 'top',
                hovertemplate: '%{text}<br>Energy: %{y:.4f} eV<extra></extra>'
            };

            if (index1 !== null && index1 >= 0 && index1 < orbitalData.energies.length) {
                selectedPoints.x.push(index1);
                selectedPoints.y.push(orbitalData.energies[index1]);
                selectedPoints.text.push(`Orbital ${index1}`);
            }

            if (index2 !== null && index2 >= 0 && index2 < orbitalData.energies.length) {
                selectedPoints.x.push(index2);
                selectedPoints.y.push(orbitalData.energies[index2]);
                selectedPoints.text.push(`Orbital ${index2}`);
            }

            // 计算视图范围
            const xRange = [
                Math.min(orbitalData.homoIndex - 2, ...selectedPoints.x),
                Math.max(orbitalData.lumoIndex + 2, ...selectedPoints.x)
            ];
            const yValues = [
                orbitalData.energies[orbitalData.homoIndex - 1],
                orbitalData.energies[orbitalData.homoIndex],
                orbitalData.energies[orbitalData.lumoIndex],
                orbitalData.energies[orbitalData.lumoIndex + 1],
                ...selectedPoints.y
            ];
            const yRange = [
                Math.min(...yValues) - 0.5,
                Math.max(...yValues) + 0.5
            ];

            const layout = {
                title: 'Orbital Energy Levels',
                xaxis: {
                    title: 'Orbital Index',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    range: xRange
                },
                yaxis: {
                    title: 'Energy (eV)',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    range: yRange
                },
                hovermode: 'closest',
                showlegend: true,
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                margin: {
                    l: 60,
                    r: 30,
                    t: 50,
                    b: 50
                }
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToAdd: ['drawline', 'drawopenpath', 'eraseshape'],
                toImageButtonOptions: {
                    format: 'png',
                    filename: 'orbital_energy_plot',
                    height: 800,
                    width: 1200,
                    scale: 2
                }
            };

            // 完全重绘图表
            Plotly.newPlot('plot', 
                [allOrbitalTrace, specialOrbitalTrace, selectedPoints], 
                layout, 
                config
            );
        }

        async function loadOrbitalData() {
            try {
                const energiesResponse = await fetch('orbitals.txt');
                const energiesText = await energiesResponse.text();
                orbitalData.energies = energiesText.trim().split('\n').map(Number);
                
                const infoResponse = await fetch('orbital_info.json');
                const info = await infoResponse.json();
                orbitalData.homoIndex = info.HOMO;
                orbitalData.lumoIndex = info.LUMO;
                
                updateReferenceInfo();
                
                document.getElementById('orbital1').value = orbitalData.lumoIndex;
                document.getElementById('orbital2').value = orbitalData.homoIndex;
                
                updateCalculations();
            } catch (error) {
                showError('Error loading orbital data: ' + error.message);
            }
        }

        // 其他函数保持不变...
        function handleSelectChange(orbitalId) {
            const select = document.getElementById(`${orbitalId}-select`);
            const input = document.getElementById(orbitalId);
            
            switch(select.value) {
                case 'HOMO':
                    input.value = orbitalData.homoIndex;
                    break;
                case 'LUMO':
                    input.value = orbitalData.lumoIndex;
                    break;
                case 'HOMO-1':
                    input.value = orbitalData.homoIndex - 1;
                    break;
                case 'LUMO+1':
                    input.value = orbitalData.lumoIndex + 1;
                    break;
                case 'custom':
                    input.value = '';
                    break;
            }
            
            updateCalculations();
        }
        
        function updateReferenceInfo() {
            ['1', '2'].forEach(suffix => {
                document.getElementById(`homo-index${suffix}`).textContent = orbitalData.homoIndex;
                document.getElementById(`lumo-index${suffix}`).textContent = orbitalData.lumoIndex;
            });
        }
        
        function getOrbitalIndex(orbitalInput) {
            if (!orbitalInput) return null;
            const index = parseInt(orbitalInput);
            return isNaN(index) ? null : index;
        }
        
        function updateCalculations() {
            const orbital1 = document.getElementById('orbital1').value;
            const orbital2 = document.getElementById('orbital2').value;
            
            const index1 = getOrbitalIndex(orbital1);
            const index2 = getOrbitalIndex(orbital2);
            
            if (index1 !== null && index1 >= 0 && index1 < orbitalData.energies.length) {
                const energy1 = orbitalData.energies[index1];
                document.getElementById('energy1').textContent = `Energy: ${energy1.toFixed(4)} eV`;
            }
            
            if (index2 !== null && index2 >= 0 && index2 < orbitalData.energies.length) {
                const energy2 = orbitalData.energies[index2];
                document.getElementById('energy2').textContent = `Energy: ${energy2.toFixed(4)} eV`;
            }
            
            if (index1 !== null && index2 !== null) {
                const gap = Math.abs(orbitalData.energies[index1] - orbitalData.energies[index2]);
                document.getElementById('gap-value').textContent = `${gap.toFixed(4)} eV`;
            }
            
            updatePlot(index1, index2);
        }
        
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
        
        // 添加事件监听器
        document.getElementById('orbital1').addEventListener('input', updateCalculations);
        document.getElementById('orbital2').addEventListener('input', updateCalculations);
        
        // 初始加载数据
        loadOrbitalData();
    </script>
</body>
</html>
