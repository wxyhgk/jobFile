<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gaussian CPL g<sub>PL</sub> è§£æå™¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Times New Roman', Times, serif;
      line-height: 1.6;
      color: #333;
      background: #fafafa;
      padding: 40px 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 1.8rem;
      font-weight: 400;
      margin-bottom: 10px;
    }

    .content {
      padding: 30px;
    }

    .note-section {
      background: #f8f9fa;
      border-left: 4px solid #3498db;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 0 4px 4px 0;
    }

    .note-section h3 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 1.1rem;
    }

    .unit {
      font-size: 0.95rem;
      color: #555;
      margin-bottom: 8px;
      display: block;
    }

    .formula {
      background: #fff;
      border: 1px solid #ddd;
      padding: 10px 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      margin: 10px 0;
    }

    .control-panel {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      align-items: center;
      flex-wrap: wrap;
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }

    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }

    .file-input-label {
      background: #3498db;
      color: white;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
      font-size: 0.9rem;
    }

    .file-input-label:hover {
      background: #2980b9;
    }

    .btn {
      background: #27ae60;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    .btn:hover {
      background: #219a52;
    }

    .btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
    }

    .btn.secondary {
      background: #e67e22;
    }

    .btn.secondary:hover {
      background: #d35400;
    }

    /* ä¼˜åŒ–æ­¥éª¤é€‰æ‹©åŒºåŸŸ */
    .step-selector {
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 20px;
      margin: 20px 0;
      display: none;
    }

    .step-selector.active {
      display: block;
    }

    .step-selector h4 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 1.1rem;
    }

    .step-info {
      margin-bottom: 15px;
      color: #555;
      font-size: 0.9rem;
    }

    .step-controls {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .step-input-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .step-input-group input {
      width: 80px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
    }

    .step-range {
      flex: 1;
      margin: 0 15px;
    }

    .step-range input[type="range"] {
      width: 100%;
      margin: 10px 0;
    }

    .step-range-display {
      text-align: center;
      font-weight: bold;
      color: #3498db;
      margin-bottom: 5px;
    }

    .step-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .step-nav-btn {
      background: #ecf0f1;
      border: 1px solid #bdc3c7;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .step-nav-btn:hover {
      background: #d5dbdb;
    }

    .step-nav-btn:disabled {
      background: #ecf0f1;
      color: #95a5a6;
      cursor: not-allowed;
    }

    /* Quick step buttons */
    .quick-steps {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .quick-step-btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s;
    }

    .quick-step-btn:hover {
      background: #2980b9;
    }

    .quick-step-btn.active {
      background: #e74c3c;
    }

    .table-container {
      margin-top: 30px;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th {
      background: #34495e;
      color: white;
      padding: 15px 10px;
      text-align: center;
      font-weight: 500;
      font-size: 0.85rem;
    }

    td {
      padding: 12px 10px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }

    tr:nth-child(even) {
      background: #f8f9fa;
    }

    tr:hover {
      background: #e8f4fd;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
    }

    .pagination button {
      background: #ecf0f1;
      border: 1px solid #bdc3c7;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .pagination button:hover {
      background: #d5dbdb;
    }

    .pagination button.active {
      background: #3498db;
      color: white;
      border-color: #3498db;
    }

    .pagination button:disabled {
      background: #ecf0f1;
      color: #95a5a6;
      cursor: not-allowed;
    }

    .pagination-info {
      margin: 0 15px;
      color: #7f8c8d;
      font-size: 0.9rem;
    }

    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      text-align: center;
    }

    .status.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .status.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .page-size-selector {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .page-size-selector select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
    }

    @media (max-width: 768px) {
      .control-panel, .step-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .control-panel > *, .step-controls > * {
        width: 100%;
        text-align: center;
      }
      
      .quick-steps {
        justify-content: center;
      }
      
      table {
        font-size: 0.8rem;
      }
      
      th, td {
        padding: 8px 5px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Gaussian CPL g<sub>PL</sub> å¤šæ­¥éª¤è§£æä¸æ•°æ®å¤„ç†</h1>
      <p>ä¸“ä¸šçš„opt TDDFTåœ†åæŒ¯å‘å…‰å…‰è°±åˆ†æå·¥å…·</p>
    </div>

    <div class="content">
      <div class="note-section">
        <h3>è®¡ç®—è¯´æ˜</h3>
        <span class="unit">â€¢ æ”¯æŒå¤šä¼˜åŒ–æ­¥éª¤çš„TDDFTè®¡ç®—ç»“æœåˆ†æ</span>
        <span class="unit">â€¢ absmiu (ç”µå¶ææ‰“å°å€¼) å•ä½ï¼šÃ—10<sup>-18</sup> esuÂ·cm</span>
        <span class="unit">â€¢ absm (ç£å¶ææ‰“å°å€¼) å•ä½ï¼šÃ—10<sup>-20</sup> ergÂ·G<sup>-1</sup></span>
        <span class="unit">â€¢ å‘å…‰ä¸å¯¹ç§°å› å­ g (glum) ä¸ºæ— é‡çº²å‚æ•°</span>
        
        <div class="formula">
          g = 4 Ã— (m<sub>cgs</sub> / Î¼<sub>cgs</sub>) Ã— cosÎ¸ Ã— 0.01
        </div>
        
        <span class="unit">æ³¨ï¼š0.01ä¸ºå•ä½å‰ç¼€ä¿®æ­£å› å­ (10<sup>-20</sup>/10<sup>-18</sup>)</span>
      </div>

      <div class="control-panel">
        <div class="file-input-wrapper">
          <input type="file" id="fileInput" accept=".log">
          <label for="fileInput" class="file-input-label">
            é€‰æ‹© Gaussian .log æ–‡ä»¶
          </label>
        </div>
        
        <button id="exportCsv" class="btn" disabled>ğŸ“„ å¯¼å‡º CSV</button>
        <button id="exportWord" class="btn secondary" disabled>ğŸ“ å¯¼å‡º Word æ–‡æ¡£</button>
        
        <div class="page-size-selector">
          <label>æ¯é¡µæ˜¾ç¤ºï¼š</label>
          <select id="pageSize">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
      </div>

      <!-- ä¼˜åŒ–æ­¥éª¤é€‰æ‹©å™¨ -->
      <div id="stepSelector" class="step-selector">
        <h4>ğŸ“ˆ é€‰æ‹©ä¼˜åŒ–æ­¥éª¤</h4>
        <div id="stepInfo" class="step-info"></div>
        
        <div class="step-controls">
          <div class="step-input-group">
            <label>è·³è½¬åˆ°æ­¥éª¤:</label>
            <input type="number" id="stepInput" min="1" value="1">
            <button id="gotoStep" class="btn">è·³è½¬</button>
          </div>
          
          <div class="step-range">
            <div id="stepRangeDisplay" class="step-range-display">æ­¥éª¤ 1</div>
            <input type="range" id="stepRange" min="1" max="1" value="1">
          </div>
          
          <div class="step-buttons">
            <button id="prevStep" class="step-nav-btn">â† ä¸Šä¸€æ­¥</button>
            <button id="nextStep" class="step-nav-btn">ä¸‹ä¸€æ­¥ â†’</button>
          </div>
        </div>
        
        <div class="quick-steps" id="quickSteps"></div>
      </div>

      <div id="status"></div>
      <div id="tableContainer"></div>
    </div>
  </div>

  <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
  <script>
    const prefixRatio = 0.01; // ä¿®æ­£ 10^-20 / 10^-18
    const fileInput = document.getElementById('fileInput');
    const container = document.getElementById('tableContainer');
    const exportCsvBtn = document.getElementById('exportCsv');
    const exportWordBtn = document.getElementById('exportWord');
    const statusDiv = document.getElementById('status');
    const pageSizeSelect = document.getElementById('pageSize');
    
    // æ­¥éª¤é€‰æ‹©ç›¸å…³å…ƒç´ 
    const stepSelector = document.getElementById('stepSelector');
    const stepInfo = document.getElementById('stepInfo');
    const stepInput = document.getElementById('stepInput');
    const gotoStepBtn = document.getElementById('gotoStep');
    const stepRange = document.getElementById('stepRange');
    const stepRangeDisplay = document.getElementById('stepRangeDisplay');
    const prevStepBtn = document.getElementById('prevStep');
    const nextStepBtn = document.getElementById('nextStep');
    const quickStepsContainer = document.getElementById('quickSteps');
    
    let allGroups = [];
    let currentStep = 1;
    let currentPage = 1;
    let pageSize = 20;
    let currentTableData = [];

    fileInput.addEventListener('change', handleFileSelect);
    exportCsvBtn.addEventListener('click', exportToCsv);
    exportWordBtn.addEventListener('click', exportToWord);
    pageSizeSelect.addEventListener('change', handlePageSizeChange);
    
    // æ­¥éª¤æ§åˆ¶äº‹ä»¶
    gotoStepBtn.addEventListener('click', () => {
      const step = parseInt(stepInput.value);
      if (step >= 1 && step <= allGroups.length) {
        setCurrentStep(step);
      }
    });
    
    stepRange.addEventListener('input', (e) => {
      setCurrentStep(parseInt(e.target.value));
    });
    
    prevStepBtn.addEventListener('click', () => {
      if (currentStep > 1) {
        setCurrentStep(currentStep - 1);
      }
    });
    
    nextStepBtn.addEventListener('click', () => {
      if (currentStep < allGroups.length) {
        setCurrentStep(currentStep + 1);
      }
    });

    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      showStatus('æ­£åœ¨è§£ææ–‡ä»¶...', 'loading');
      
      const reader = new FileReader();
      reader.onload = () => {
        try {
          parseLog(reader.result);
        } catch (error) {
          showStatus('æ–‡ä»¶è§£æå¤±è´¥ï¼š' + error.message, 'error');
        }
      };
      reader.readAsText(file);
    }

    function parseLog(text) {
      const lines = text.split('\n');
      const elecStarts = [];
      const magStarts = [];
      
      lines.forEach((line, i) => {
        if (line.includes('Ground to excited state transition electric dipole moments')) {
          elecStarts.push(i);
        }
        if (line.includes('Ground to excited state transition magnetic dipole moments')) {
          magStarts.push(i);
        }
      });
      
      const nGroups = Math.min(elecStarts.length, magStarts.length);
      if (nGroups === 0) {
        showStatus('æœªæ‰¾åˆ° Transition dipole æ•°æ®ï¼Œè¯·æ£€æŸ¥ log æ–‡ä»¶æ ¼å¼', 'error');
        return;
      }
      
      allGroups = [];
      
      for (let g = 0; g < nGroups; g++) {
        // ç”µå¶æåŒºæ®µ
        const eStart = elecStarts[g] + 1;
        const eEnd = lines.slice(eStart).findIndex(l => 
          l.includes('Ground to excited state transition velocity') ||
          l.includes('Ground to excited state transition magnetic dipole moments')
        );
        const elecLines = lines.slice(eStart, eStart + (eEnd > 0 ? eEnd : lines.length))
                               .filter(l => /^\s*\d+/.test(l));
        
        // ç£å¶æåŒºæ®µ
        const mStart = magStarts[g] + 1;
        const mEnd = lines.slice(mStart).findIndex(l => l.trim() === '');
        const magLines = lines.slice(mStart, mStart + (mEnd > 0 ? mEnd : lines.length))
                               .filter(l => /^\s*\d+/.test(l));
        
        // æŒ‰å®é™…çŠ¶æ€æ•°é‡è§£æ
        const nStates = Math.min(elecLines.length, magLines.length);
        const records = [];
        
        for (let i = 0; i < nStates; i++) {
          const eVals = elecLines[i].trim().split(/\s+/).slice(1, 4).map(Number);
          const mVals = magLines[i].trim().split(/\s+/).slice(1, 4).map(Number);
          const mu = Math.hypot(...eVals);
          const m = Math.hypot(...mVals);
          const dot = eVals[0]*mVals[0] + eVals[1]*mVals[1] + eVals[2]*mVals[2];
          const cosÎ¸ = dot / (mu * m);
          const absmiu = mu * 2.541746;
          const absm = m * 2 * 9.274e-1;
          const gVal = 4 * (absm / absmiu) * prefixRatio * cosÎ¸;
          
          records.push({
            state: i + 1,
            absmiu: absmiu.toFixed(6),
            absm: absm.toFixed(6),
            cosTheta: cosÎ¸.toFixed(6),
            g: gVal.toFixed(6),
            g1000: (gVal * 1000).toFixed(3)
          });
        }
        
        allGroups.push(records);
      }
      
      // åˆå§‹åŒ–æ­¥éª¤é€‰æ‹©å™¨
      initializeStepSelector();
      setCurrentStep(1);
      exportCsvBtn.disabled = false;
      exportWordBtn.disabled = false;
      showStatus(`æˆåŠŸè§£æ ${nGroups} ä¸ªä¼˜åŒ–æ­¥éª¤ï¼Œå…± ${allGroups.reduce((sum, group) => sum + group.length, 0)} ä¸ªæ¿€å‘æ€æ•°æ®`, 'success');
    }

    function initializeStepSelector() {
      if (allGroups.length === 0) {
        stepSelector.classList.remove('active');
        return;
      }
      
      stepSelector.classList.add('active');
      
      // æ›´æ–°æ­¥éª¤ä¿¡æ¯
      stepInfo.textContent = `å‘ç° ${allGroups.length} ä¸ªä¼˜åŒ–æ­¥éª¤ï¼Œæ¯æ­¥åŒ…å« ${allGroups.map(g => g.length + 'ä¸ªçŠ¶æ€').join(', ')}`;
      
      // è®¾ç½®æ»‘å—èŒƒå›´
      stepRange.max = allGroups.length;
      stepInput.max = allGroups.length;
      
      // ç”Ÿæˆå¿«é€Ÿè·³è½¬æŒ‰é’®
      generateQuickStepButtons();
    }

    function generateQuickStepButtons() {
      quickStepsContainer.innerHTML = '';
      
      const totalSteps = allGroups.length;
      if (totalSteps <= 20) {
        // å°‘äº20æ­¥ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ­¥éª¤
        for (let i = 1; i <= totalSteps; i++) {
          createQuickStepButton(i);
        }
      } else {
        // å¤šäº20æ­¥ï¼Œæ˜¾ç¤ºå…³é”®æ­¥éª¤
        const keySteps = [1, 5, 10, 25, 50, 75, 100, totalSteps];
        keySteps.filter(step => step <= totalSteps).forEach(step => {
          createQuickStepButton(step);
        });
        
        // æ·»åŠ ä¸­é—´æ­¥éª¤
        if (totalSteps > 100) {
          const interval = Math.floor(totalSteps / 10);
          for (let i = interval; i < totalSteps; i += interval) {
            if (!keySteps.includes(i)) {
              createQuickStepButton(i);
            }
          }
        }
      }
    }

    function createQuickStepButton(step) {
      const btn = document.createElement('button');
      btn.className = 'quick-step-btn';
      btn.textContent = step;
      btn.addEventListener('click', () => setCurrentStep(step));
      quickStepsContainer.appendChild(btn);
    }

    function setCurrentStep(step) {
      currentStep = step;
      currentPage = 1;
      
      // æ›´æ–°UI
      stepInput.value = step;
      stepRange.value = step;
      stepRangeDisplay.textContent = `æ­¥éª¤ ${step}`;
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      prevStepBtn.disabled = step === 1;
      nextStepBtn.disabled = step === allGroups.length;
      
      // æ›´æ–°å¿«é€Ÿè·³è½¬æŒ‰é’®
      document.querySelectorAll('.quick-step-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.textContent) === step);
      });
      
      // æ˜¾ç¤ºå½“å‰æ­¥éª¤çš„æ•°æ®
      currentTableData = allGroups[step - 1] || [];
      renderTable();
    }

    function renderTable() {
      if (currentTableData.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">æ²¡æœ‰æ•°æ®</div>';
        return;
      }

      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = Math.min(startIndex + pageSize, currentTableData.length);
      const pageData = currentTableData.slice(startIndex, endIndex);

      let html = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>State</th>
                <th>Î¼ (Ã—10<sup>-18</sup> esuÂ·cm)</th>
                <th>m (Ã—10<sup>-20</sup> ergÂ·G<sup>-1</sup>)</th>
                <th>cosÎ¸</th>
                <th>g</th>
                <th>g Ã—1000</th>
              </tr>
            </thead>
            <tbody>
      `;

      pageData.forEach(r => {
        html += `
          <tr>
            <td>${r.state}</td>
            <td>${r.absmiu}</td>
            <td>${r.absm}</td>
            <td>${r.cosTheta}</td>
            <td>${r.g}</td>
            <td>${r.g1000}</td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
          ${renderPagination()}
        </div>
      `;

      container.innerHTML = html;
      attachPaginationEvents();
    }

    function renderPagination() {
      if (currentTableData.length <= pageSize) return '';

      const totalPages = Math.ceil(currentTableData.length / pageSize);
      const startItem = (currentPage - 1) * pageSize + 1;
      const endItem = Math.min(currentPage * pageSize, currentTableData.length);

      let html = `
        <div class="pagination">
          <button id="prevPage" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
      `;

      // æ˜¾ç¤ºé¡µç æŒ‰é’®
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

      if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }

      for (let i = startPage; i <= endPage; i++) {
        html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
      }

      html += `
          <button id="nextPage" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
          <div class="pagination-info">
            æ­¥éª¤ ${currentStep}: æ˜¾ç¤º ${startItem}-${endItem} é¡¹ï¼Œå…± ${currentTableData.length} é¡¹
          </div>
        </div>
      `;

      return html;
    }

    function attachPaginationEvents() {
      document.getElementById('prevPage')?.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderTable();
        }
      });

      document.getElementById('nextPage')?.addEventListener('click', () => {
        const totalPages = Math.ceil(currentTableData.length / pageSize);
        if (currentPage < totalPages) {
          currentPage++;
          renderTable();
        }
      });

      document.querySelectorAll('.page-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          currentPage = parseInt(e.target.dataset.page);
          renderTable();
        });
      });
    }

    function handlePageSizeChange(e) {
      pageSize = parseInt(e.target.value);
      currentPage = 1;
      if (currentTableData.length > 0) {
        renderTable();
      }
    }

    function exportToCsv() {
      if (!allGroups.length) return;
      
      let csvContent = '';
      
      // å¯¼å‡ºæ‰€æœ‰æ­¥éª¤çš„æ•°æ®
      allGroups.forEach((group, stepIndex) => {
        csvContent += `\nä¼˜åŒ–æ­¥éª¤ ${stepIndex + 1}\n`;
        csvContent += 'State,Î¼(Ã—10^-18 esuÂ·cm),m(Ã—10^-20 ergÂ·G^-1),cosÎ¸,g,gÃ—1000\n';
        group.forEach(r => {
          csvContent += `${r.state},${r.absmiu},${r.absm},${r.cosTheta},${r.g},${r.g1000}\n`;
        });
      });
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `gaussian_cpl_gPL_all_steps_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      showStatus('CSV æ–‡ä»¶å·²å¯¼å‡ºï¼ˆåŒ…å«æ‰€æœ‰æ­¥éª¤ï¼‰', 'success');
    }

    async function exportToWord() {
      if (!allGroups.length) return;

      try {
        showStatus('æ­£åœ¨ç”Ÿæˆ Word æ–‡æ¡£...', 'loading');
        
        // æ£€æŸ¥docxåº“æ˜¯å¦åŠ è½½
        if (typeof docx === 'undefined') {
          throw new Error('Wordå¯¼å‡ºåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        }

        const sections = [];
        
        // ä¸ºæ¯ä¸ªæ­¥éª¤åˆ›å»ºè¡¨æ ¼
        allGroups.forEach((group, stepIndex) => {
          const tableRows = [
            new docx.TableRow({
              children: [
                new docx.TableCell({ children: [new docx.Paragraph("State")] }),
                new docx.TableCell({ children: [new docx.Paragraph("Î¼ (Ã—10â»Â¹â¸ esuÂ·cm)")] }),
                new docx.TableCell({ children: [new docx.Paragraph("m (Ã—10â»Â²â° ergÂ·Gâ»Â¹)")] }),
                new docx.TableCell({ children: [new docx.Paragraph("cosÎ¸")] }),
                new docx.TableCell({ children: [new docx.Paragraph("g")] }),
                new docx.TableCell({ children: [new docx.Paragraph("g Ã— 1000")] }),
              ],
            }),
            ...group.map(row => new docx.TableRow({
              children: [
                new docx.TableCell({ children: [new docx.Paragraph(row.state.toString())] }),
                new docx.TableCell({ children: [new docx.Paragraph(row.absmiu)] }),
                new docx.TableCell({ children: [new docx.Paragraph(row.absm)] }),
                new docx.TableCell({ children: [new docx.Paragraph(row.cosTheta)] }),
                new docx.TableCell({ children: [new docx.Paragraph(row.g)] }),
                new docx.TableCell({ children: [new docx.Paragraph(row.g1000)] }),
              ],
            }))
          ];

          sections.push({
            properties: {},
            children: [
              new docx.Paragraph({
                children: [new docx.TextRun({ 
                  text: stepIndex === 0 ? "Gaussian CPL gPL å¤šæ­¥éª¤è®¡ç®—ç»“æœ" : "", 
                  bold: true, 
                  size: 32 
                })],
                alignment: docx.AlignmentType.CENTER,
                spacing: { after: 400 }
              }),
              new docx.Paragraph({
                children: [new docx.TextRun({ 
                  text: `ä¼˜åŒ–æ­¥éª¤ ${stepIndex + 1} (${group.length} ä¸ªæ¿€å‘æ€)`, 
                  bold: true,
                  size: 28 
                })],
                spacing: { after: 200 }
              }),
              new docx.Table({
                rows: tableRows,
                width: { size: 100, type: docx.WidthType.PERCENTAGE },
                borders: {
                  top: { style: docx.BorderStyle.SINGLE, size: 1 },
                  bottom: { style: docx.BorderStyle.SINGLE, size: 1 },
                  left: { style: docx.BorderStyle.SINGLE, size: 1 },
                  right: { style: docx.BorderStyle.SINGLE, size: 1 },
                  insideHorizontal: { style: docx.BorderStyle.SINGLE, size: 1 },
                  insideVertical: { style: docx.BorderStyle.SINGLE, size: 1 },
                }
              }),
              new docx.Paragraph({ text: "" }) // ç©ºè¡Œ
            ]
          });
        });

        const doc = new docx.Document({ sections });

        const buffer = await docx.Packer.toBlob(doc);
        const url = URL.createObjectURL(buffer);
        const a = document.createElement('a');
        a.href = url;
        a.download = `gaussian_cpl_gPL_all_steps_${new Date().toISOString().split('T')[0]}.docx`;
        a.click();
        URL.revokeObjectURL(url);
        
        showStatus('Word æ–‡æ¡£å·²å¯¼å‡ºï¼ˆåŒ…å«æ‰€æœ‰æ­¥éª¤ï¼‰', 'success');
        
      } catch (error) {
        console.error('Word å¯¼å‡ºå¤±è´¥:', error);
        showStatus('Word å¯¼å‡ºå¤±è´¥ï¼š' + error.message + 'ï¼Œè¯·å°è¯• CSV å¯¼å‡º', 'error');
      }
    }

    function showStatus(message, type = 'success') {
      let icon = '';
      if (type === 'loading') {
        icon = '<div class="loading"></div>';
      }
      
      statusDiv.innerHTML = `<div class="status ${type}">${icon}${message}</div>`;
      
      if (type !== 'loading') {
        setTimeout(() => {
          statusDiv.innerHTML = '';
        }, 3000);
      }
    }
  </script>
</body>
</html>
