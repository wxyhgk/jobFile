<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gaussian CPL g<sub>PL</sub> 解析器</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Times New Roman', Times, serif;
      line-height: 1.6;
      color: #333;
      background: #fafafa;
      padding: 40px 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 1.8rem;
      font-weight: 400;
      margin-bottom: 10px;
    }

    .content {
      padding: 30px;
    }

    .note-section {
      background: #f8f9fa;
      border-left: 4px solid #3498db;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 0 4px 4px 0;
    }

    .note-section h3 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 1.1rem;
    }

    .unit {
      font-size: 0.95rem;
      color: #555;
      margin-bottom: 8px;
      display: block;
    }

    .formula {
      background: #fff;
      border: 1px solid #ddd;
      padding: 10px 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      margin: 10px 0;
    }

    .control-panel {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      align-items: center;
      flex-wrap: wrap;
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }

    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }

    .file-input-label {
      background: #3498db;
      color: white;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
      font-size: 0.9rem;
    }

    .file-input-label:hover {
      background: #2980b9;
    }

    .btn {
      background: #27ae60;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    .btn:hover {
      background: #219a52;
    }

    .btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
    }

    .btn.secondary {
      background: #e67e22;
    }

    .btn.secondary:hover {
      background: #d35400;
    }

    .table-container {
      margin-top: 30px;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th {
      background: #34495e;
      color: white;
      padding: 15px 10px;
      text-align: center;
      font-weight: 500;
      font-size: 0.85rem;
    }

    td {
      padding: 12px 10px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }

    tr:nth-child(even) {
      background: #f8f9fa;
    }

    tr:hover {
      background: #e8f4fd;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
    }

    .pagination button {
      background: #ecf0f1;
      border: 1px solid #bdc3c7;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .pagination button:hover {
      background: #d5dbdb;
    }

    .pagination button.active {
      background: #3498db;
      color: white;
      border-color: #3498db;
    }

    .pagination button:disabled {
      background: #ecf0f1;
      color: #95a5a6;
      cursor: not-allowed;
    }

    .pagination-info {
      margin: 0 15px;
      color: #7f8c8d;
      font-size: 0.9rem;
    }

    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      text-align: center;
    }

    .status.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .status.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .page-size-selector {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .page-size-selector select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
    }

    @media (max-width: 768px) {
      .control-panel {
        flex-direction: column;
        align-items: stretch;
      }
      
      .control-panel > * {
        width: 100%;
        text-align: center;
      }
      
      table {
        font-size: 0.8rem;
      }
      
      th, td {
        padding: 8px 5px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Gaussian CPL g<sub>PL</sub> 解析与数据处理</h1>
      <p>专业的圆偏振发光光谱分析工具</p>
    </div>

    <div class="content">
      <div class="note-section">
        <h3>计算说明</h3>
        <span class="unit">• absmiu (电偶极打印值) 单位：×10<sup>-18</sup> esu·cm</span>
        <span class="unit">• absm (磁偶极打印值) 单位：×10<sup>-20</sup> erg·G<sup>-1</sup></span>
        <span class="unit">• 发光不对称因子 g (glum) 为无量纲参数</span>
        
        <div class="formula">
          g = 4 × (m<sub>cgs</sub> / μ<sub>cgs</sub>) × cosθ
        </div>
        
        <span class="unit">注：因打印值的单位前缀 10<sup>-20</sup>/10<sup>-18</sup> = 10<sup>-2</sup>，计算中已乘以 0.01 进行修正。</span>
      </div>

      <div class="control-panel">
        <div class="file-input-wrapper">
          <input type="file" id="fileInput" accept=".log">
          <label for="fileInput" class="file-input-label">
            选择 Gaussian .log 文件
          </label>
        </div>
        
        <button id="exportCsv" class="btn" disabled>📄 导出 CSV</button>
        <button id="exportWord" class="btn secondary" disabled>📝 导出 Word 文档</button>
        
        <div class="page-size-selector">
          <label>每页显示：</label>
          <select id="pageSize">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
      </div>

      <div id="status"></div>
      <div id="tableContainer"></div>
    </div>
  </div>

  <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
  <script>
    const prefixRatio = 0.01; // 修正 10^-20 / 10^-18
    const fileInput = document.getElementById('fileInput');
    const container = document.getElementById('tableContainer');
    const exportCsvBtn = document.getElementById('exportCsv');
    const exportWordBtn = document.getElementById('exportWord');
    const statusDiv = document.getElementById('status');
    const pageSizeSelect = document.getElementById('pageSize');
    
    let tableData = [];
    let currentPage = 1;
    let pageSize = 20;

    fileInput.addEventListener('change', handleFileSelect);
    exportCsvBtn.addEventListener('click', exportToCsv);
    exportWordBtn.addEventListener('click', exportToWord);
    pageSizeSelect.addEventListener('change', handlePageSizeChange);

    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      showStatus('正在解析文件...', 'loading');
      
      const reader = new FileReader();
      reader.onload = () => {
        try {
          parseLog(reader.result);
        } catch (error) {
          showStatus('文件解析失败：' + error.message, 'error');
        }
      };
      reader.readAsText(file);
    }

    function parseLog(text) {
      const lines = text.split('\n');
      const elecLines = [];
      const magLines = [];
      let parsingElec = false;
      let parsingMag = false;

      for (let line of lines) {
        // 开始电偶极部分
        if (line.includes('Ground to excited state transition electric dipole moments')) {
          parsingElec = true;
          continue;
        }
        // 电偶极遇到下一个 velocity 或 magnetic 段就停止
        if (parsingElec &&
            (line.includes('Ground to excited state transition velocity') ||
             line.includes('Ground to excited state transition magnetic dipole moments'))) {
          parsingElec = false;
        }
        if (parsingElec && /^\s*\d+/.test(line)) {
          elecLines.push(line.trim());
        }

        // 开始磁偶极部分
        if (line.includes('Ground to excited state transition magnetic dipole moments')) {
          parsingMag = true;
          continue;
        }
        // 碰到空行就结束磁偶极部分
        if (parsingMag && line.trim() === '') {
          parsingMag = false;
        }
        if (parsingMag && /^\s*\d+/.test(line)) {
          magLines.push(line.trim());
        }
      }

      if (elecLines.length === 0 || magLines.length === 0) {
        showStatus('未找到 Transition dipole 数据，请检查 log 文件格式', 'error');
        return;
      }

      tableData = elecLines.map((el, idx) => {
        const e = el.split(/\s+/).slice(1, 4).map(Number);
        const m = magLines[idx].split(/\s+/).slice(1, 4).map(Number);
        const muMag = Math.hypot(...e);
        const mMag = Math.hypot(...m);
        const dot = e[0]*m[0] + e[1]*m[1] + e[2]*m[2];
        const cosTheta = dot / (muMag * mMag);

        // 打印值单位已是 ×10^-18 和 ×10^-20
        const absmiu = muMag * 2.541746;      // a.u. to 10^-18 esu·cm
        const absm = mMag * 2 * 9.274e-1;     // a.u. to 10^-20 erg·G^-1

        // g 计算加上前缀修正
        const gVal = 4 * (absm / absmiu) * prefixRatio * cosTheta;

        return {
          state: idx + 1,
          absmiu: absmiu.toFixed(6),
          absm: absm.toFixed(6),
          cosTheta: cosTheta.toFixed(6),
          g: gVal.toFixed(6),
          g1000: (gVal * 1000).toFixed(3)
        };
      });

      currentPage = 1;
      renderTable();
      exportCsvBtn.disabled = false;
      exportWordBtn.disabled = false;
      showStatus(`成功解析 ${tableData.length} 个激发态数据`, 'success');
    }

    function renderTable() {
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = Math.min(startIndex + pageSize, tableData.length);
      const pageData = tableData.slice(startIndex, endIndex);

      let html = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>State</th>
                <th>μ (×10<sup>-18</sup> esu·cm)</th>
                <th>m (×10<sup>-20</sup> erg·G<sup>-1</sup>)</th>
                <th>cosθ</th>
                <th>g</th>
                <th>g ×1000</th>
              </tr>
            </thead>
            <tbody>
      `;

      pageData.forEach(r => {
        html += `
          <tr>
            <td>${r.state}</td>
            <td>${r.absmiu}</td>
            <td>${r.absm}</td>
            <td>${r.cosTheta}</td>
            <td>${r.g}</td>
            <td>${r.g1000}</td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
          ${renderPagination()}
        </div>
      `;

      container.innerHTML = html;
      attachPaginationEvents();
    }

    function renderPagination() {
      if (tableData.length <= pageSize) return '';

      const totalPages = Math.ceil(tableData.length / pageSize);
      const startItem = (currentPage - 1) * pageSize + 1;
      const endItem = Math.min(currentPage * pageSize, tableData.length);

      let html = `
        <div class="pagination">
          <button id="prevPage" ${currentPage === 1 ? 'disabled' : ''}>上一页</button>
      `;

      // 显示页码按钮
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

      if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }

      for (let i = startPage; i <= endPage; i++) {
        html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
      }

      html += `
          <button id="nextPage" ${currentPage === totalPages ? 'disabled' : ''}>下一页</button>
          <div class="pagination-info">
            显示 ${startItem}-${endItem} 项，共 ${tableData.length} 项
          </div>
        </div>
      `;

      return html;
    }

    function attachPaginationEvents() {
      document.getElementById('prevPage')?.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderTable();
        }
      });

      document.getElementById('nextPage')?.addEventListener('click', () => {
        const totalPages = Math.ceil(tableData.length / pageSize);
        if (currentPage < totalPages) {
          currentPage++;
          renderTable();
        }
      });

      document.querySelectorAll('.page-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          currentPage = parseInt(e.target.dataset.page);
          renderTable();
        });
      });
    }

    function handlePageSizeChange(e) {
      pageSize = parseInt(e.target.value);
      currentPage = 1;
      if (tableData.length > 0) {
        renderTable();
      }
    }

    function exportToCsv() {
      if (!tableData.length) return;
      
      const header = 'State,μ(×10^-18 esu·cm),m(×10^-20 erg·G^-1),cosθ,g,g×1000';
      const rows = tableData.map(r => `${r.state},${r.absmiu},${r.absm},${r.cosTheta},${r.g},${r.g1000}`);
      const csvContent = header + '\n' + rows.join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `gaussian_cpl_gPL_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      showStatus('CSV 文件已导出', 'success');
    }

    async function exportToWord() {
      if (!tableData.length) return;

      try {
        showStatus('正在生成 Word 文档...', 'loading');
        
        // 检查docx库是否加载
        if (typeof docx === 'undefined') {
          throw new Error('Word导出库未加载，请刷新页面重试');
        }

        // 创建表格行数据
        const tableRows = [
          new docx.TableRow({
            children: [
              new docx.TableCell({ children: [new docx.Paragraph("State")] }),
              new docx.TableCell({ children: [new docx.Paragraph("μ (×10⁻¹⁸ esu·cm)")] }),
              new docx.TableCell({ children: [new docx.Paragraph("m (×10⁻²⁰ erg·G⁻¹)")] }),
              new docx.TableCell({ children: [new docx.Paragraph("cosθ")] }),
              new docx.TableCell({ children: [new docx.Paragraph("g")] }),
              new docx.TableCell({ children: [new docx.Paragraph("g × 1000")] }),
            ],
          }),
          ...tableData.map(row => new docx.TableRow({
            children: [
              new docx.TableCell({ children: [new docx.Paragraph(row.state.toString())] }),
              new docx.TableCell({ children: [new docx.Paragraph(row.absmiu)] }),
              new docx.TableCell({ children: [new docx.Paragraph(row.absm)] }),
              new docx.TableCell({ children: [new docx.Paragraph(row.cosTheta)] }),
              new docx.TableCell({ children: [new docx.Paragraph(row.g)] }),
              new docx.TableCell({ children: [new docx.Paragraph(row.g1000)] }),
            ],
          }))
        ];

        const doc = new docx.Document({
          sections: [{
            properties: {},
            children: [
              new docx.Paragraph({
                children: [new docx.TextRun({ 
                  text: "Gaussian CPL gPL 计算结果", 
                  bold: true, 
                  size: 32 
                })],
                alignment: docx.AlignmentType.CENTER,
                spacing: { after: 400 }
              }),
              new docx.Paragraph({
                children: [new docx.TextRun({ 
                  text: "计算说明：g = 4 × (m_cgs / μ_cgs) × cosθ × 0.01", 
                  size: 24 
                })],
                spacing: { after: 200 }
              }),
              new docx.Table({
                rows: tableRows,
                width: { size: 100, type: docx.WidthType.PERCENTAGE },
                borders: {
                  top: { style: docx.BorderStyle.SINGLE, size: 1 },
                  bottom: { style: docx.BorderStyle.SINGLE, size: 1 },
                  left: { style: docx.BorderStyle.SINGLE, size: 1 },
                  right: { style: docx.BorderStyle.SINGLE, size: 1 },
                  insideHorizontal: { style: docx.BorderStyle.SINGLE, size: 1 },
                  insideVertical: { style: docx.BorderStyle.SINGLE, size: 1 },
                }
              })
            ]
          }]
        });

        const buffer = await docx.Packer.toBlob(doc);
        const url = URL.createObjectURL(buffer);
        const a = document.createElement('a');
        a.href = url;
        a.download = `gaussian_cpl_gPL_results_${new Date().toISOString().split('T')[0]}.docx`;
        a.click();
        URL.revokeObjectURL(url);
        
        showStatus('Word 文档已导出', 'success');
        
      } catch (error) {
        console.error('Word 导出失败:', error);
        showStatus('Word 导出失败：' + error.message + '，请尝试 CSV 导出', 'error');
      }
    }

    function showStatus(message, type = 'success') {
      let icon = '';
      if (type === 'loading') {
        icon = '<div class="loading"></div>';
      }
      
      statusDiv.innerHTML = `<div class="status ${type}">${icon}${message}</div>`;
      
      if (type !== 'loading') {
        setTimeout(() => {
          statusDiv.innerHTML = '';
        }, 3000);
      }
    }
  </script>
</body>
</html>
